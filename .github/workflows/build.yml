name: Â¡Auto Release

on:
  workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        runtime: [win-x64, linux-x64, osx-x64]

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Clone Hack.io
        run: |
          git clone https://github.com/SuperHackio/Hack.io.git
          cp -r Hack.io/Hack.io/Hack.io Hack.io/Hack.io.BCSV .
          rm -rf Hack.io

      - name: Restore dependencies
        run: dotnet restore

      - name: Build self-contained single file
        run: |
          dotnet publish CutsceneMaker/CutsceneMaker.csproj \
            -c Release \
            -r ${{ matrix.runtime }} \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            /p:PublishTrimmed=false \
            -o publish/${{ matrix.runtime }}

      - name: Copy Templates
        run: |
          mkdir -p publish/${{ matrix.runtime }}/Templates
          cp -r CutsceneMaker/Templates publish/${{ matrix.runtime }}/Templates

      - name: Zip output
        run: |
          cd publish
          zip -r CutsceneMaker-${{ matrix.runtime }}.zip ${{ matrix.runtime }}

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: CutsceneMaker-${{ matrix.runtime }}
          path: publish/CutsceneMaker-${{ matrix.runtime }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Auto
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/CutsceneMaker-*.zip
